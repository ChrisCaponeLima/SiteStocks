generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model RoleLevel {
  id    Int    @id @default(autoincrement())
  name  String @unique @db.VarChar(50)
  level Int    @unique
  users User[]
}

model User {
  id                  Int                   @id @default(autoincrement())
  cpf                 String                @unique @db.VarChar(14)
  password            String
  nome                String                @db.VarChar(100)
  sobrenome           String                @db.VarChar(100)
  telefone            String?               @db.VarChar(15)
  email               String                @unique @db.VarChar(100)
  cotistaId           Int?                  @unique
  roleId              Int                   @default(1)
  ultimoAcesso        DateTime?
  ativo               Boolean?              @default(true)
  DepositoPixPendente DepositoPixPendente[]
  cotista             Cotista?              @relation(fields: [cotistaId], references: [id], onDelete: Restrict)
  role                RoleLevel             @relation(fields: [roleId], references: [id])
}

model Cotista {
  id                   Int                    @id @default(autoincrement())
  dataCriacao          DateTime               @default(now())
  fundoId              Int?
  capitalInicial       Decimal                @db.Decimal(18, 2)
  aporteMensalPadrao   Decimal                @default(0) @db.Decimal(18, 2)
  numeroDaConta        String                 @unique @db.VarChar(20)
  fundo                Fundo?                 @relation(fields: [fundoId], references: [id], onDelete: Restrict)
  DepositoPixPendente  DepositoPixPendente[]
  movimentacoes        MovimentacaoCotista[]
  PixCopiaColaEstatico PixCopiaColaEstatico[]
  user                 User?
}

model Fundo {
  id                     Int                   @id @default(autoincrement())
  nome                   String                @db.VarChar(100)
  cnpj                   String                @unique @db.VarChar(18)
  taxaAdm                Decimal               @default(0.0) @db.Decimal(4, 4)
  dataInicio             DateTime              @db.Date
  cotistas               Cotista[]
  historicoRentabilidade RentabilidadeMensal[]
}

model RentabilidadeMensal {
  id            Int      @id @default(autoincrement())
  fundoId       Int
  mesAno        DateTime @db.Date
  valorFundo    Decimal  @db.Decimal(18, 2)
  valorPoupanca Decimal  @db.Decimal(18, 2)
  rendimentoMes Decimal  @db.Decimal(18, 8)
  fundo         Fundo    @relation(fields: [fundoId], references: [id])

  @@unique([fundoId, mesAno])
}

model MovimentacaoCotista {
  id               Int              @id @default(autoincrement())
  cotistaId        Int
  dataMovimentacao DateTime         @db.Date
  tipo             TipoMovimentacao
  valor            Decimal          @db.Decimal(18, 2)
  cotista          Cotista          @relation(fields: [cotistaId], references: [id])

  @@index([cotistaId, dataMovimentacao])
}

model DepositoPixPendente {
  id              Int            @id @default(autoincrement())
  cotistaId       Int
  valorSolicitado Decimal        @db.Decimal(18, 2)
  dataSolicitacao DateTime       @default(now())
  status          StatusDeposito @default(PENDENTE)
  gerenteId       Int?
  dataValidacao   DateTime?
  pixPayload      String         @db.VarChar(400)
  Cotista         Cotista        @relation(fields: [cotistaId], references: [id])
  User            User?          @relation(fields: [gerenteId], references: [id])

  @@index([cotistaId, status])
}

model PixCopiaColaEstatico {
  id                   Int       @id @default(autoincrement())
  codigo               String    @unique @db.VarChar(400)
  valorInformado       Decimal?  @db.Decimal(18, 2)
  dataCriacao          DateTime  @default(now())
  utilizadoEm          DateTime?
  cotistaQueUtilizouId Int?
  status               String    @default("PENDENTE") @db.VarChar(20)
  Cotista              Cotista?  @relation(fields: [cotistaQueUtilizouId], references: [id])

  @@index([status])
}

enum TipoMovimentacao {
  APORTE
  RESGATE
  RENDIMENTO
}

enum StatusDeposito {
  PENDENTE
  APROVADO
  REJEITADO
}
